/*
    *
    * Wijmo Library 5.20183.550
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */
"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var wjcGrid=require("wijmo/wijmo.grid"),wjcCore=require("wijmo/wijmo"),wjcInput=require("wijmo/wijmo.input"),__glob="undefined"!=typeof window?window:self,wjcSelfRef=require("wijmo/wijmo.grid.filter"),wjcSelf=wjcSelfRef||exports;__glob.wijmo=__glob.wijmo||{},__glob.wijmo.grid=__glob.wijmo.grid||{},__glob.wijmo.grid.filter=wjcSelf;var ValueFilter=function(){function e(e){this._maxValues=250,this._sortValues=!0,this._col=e,this._bnd=e.binding?new wjcCore.Binding(e.binding):null}return Object.defineProperty(e.prototype,"showValues",{get:function(){return this._values},set:function(e){this._values=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterText",{get:function(){return this._filterText},set:function(e){this._filterText=wjcCore.asString(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxValues",{get:function(){return this._maxValues},set:function(e){this._maxValues=wjcCore.asNumber(e,!1,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uniqueValues",{get:function(){return this._uniqueValues},set:function(e){this._uniqueValues=wjcCore.asArray(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sortValues",{get:function(){return this._sortValues},set:function(e){this._sortValues=wjcCore.asBoolean(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataMap",{get:function(){return this._map},set:function(e){this._map=wjcCore.asType(e,wjcGrid.DataMap,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"column",{get:function(){return this._col},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isActive",{get:function(){return null!=this._values&&Object.keys(this._values).length>0},enumerable:!0,configurable:!0}),e.prototype.apply=function(e){var t=this.column;return!(this._bnd&&this._values&&Object.keys(this._values).length)||(e=this._bnd.getValue(e),e=this.dataMap?this.dataMap.getDisplayValue(e):t.dataMap?t.dataMap.getDisplayValue(e):wjcCore.Globalize.format(e,t.format),void 0!=this._values[e])},e.prototype.clear=function(){this.showValues=null,this.filterText=null},e.prototype.implementsInterface=function(e){return"IColumnFilter"==e},e.prototype._getUniqueValues=function(e,t){var i=[];if(this.uniqueValues){for(var r=this.uniqueValues,n=0;n<r.length;n++){u=r[n];i.push({value:u,text:u.toString()})}return i}var o={},l=e.collectionView,a=l?l.sourceCollection:[];if(t&&l&&l.sourceCollection&&l.filter){var s=this.showValues;this.showValues=null;for(var c=[],n=0;n<a.length;n++)l.filter(a[n])&&c.push(a[n]);a=c,this.showValues=s}for(n=0;n<a.length;n++){var u=e._binding.getValue(a[n]),d=this.dataMap?this.dataMap.getDisplayValue(u):e.dataMap?e.dataMap.getDisplayValue(u):wjcCore.Globalize.format(u,e.format);o[d]||(o[d]=!0,i.push({value:u,text:d}))}return i},e}();exports.ValueFilter=ValueFilter;var ValueFilterEditor=function(e){function t(t,i){var r=e.call(this,t)||this;r._filter=wjcCore.asType(i,ValueFilter,!1);var n=r.getTemplate();r.applyTemplate("wj-control wj-valuefilter-editor",n,{_divFilter:"div-filter",_cbSelectAll:"cb-select-all",_spSelectAll:"sp-select-all",_divValues:"div-values"}),r._cbSelectAll.tabIndex=0;var o=wjcCore.culture.FlexGridFilter;wjcCore.setText(r._spSelectAll,o.selectAll);var l=r._view=new wjcCore.CollectionView;if(l.sortNullsFirst=!0,i.sortValues){var a=i.column.dataMap||i.dataMap?"text":"value",s=i.column.dataType!=wjcCore.DataType.Boolean;l.sortDescriptions.push(new wjcCore.SortDescription(a,s))}return l.filter=r._filterValues.bind(r),l.collectionChanged.addHandler(r._updateSelectAllCheck,r),r._filterText="",r._cmbFilter=new wjcInput.ComboBox(r._divFilter,{placeholder:o.search}),r._lbValues=new wjcInput.ListBox(r._divValues,{displayMemberPath:"text",checkedMemberPath:"show",itemsSource:r._view,itemFormatter:function(e,t){return t||o.null}}),wjcCore.setAriaLabel(r._cmbFilter.inputElement,o.ariaLabels.search),r._cmbFilter.textChanged.addHandler(r._filterTextChanged,r),r._cbSelectAll.addEventListener("click",r._cbSelectAllClicked.bind(r)),r.updateEditor(),r}return __extends(t,e),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),t.prototype.updateEditor=function(){var e=this,t=this._filter.column,i=this._filter._getUniqueValues(t,!0);this._lbValues.isContentHtml=t.isContentHtml;var r=this._filter.showValues;if(r&&0!=Object.keys(r).length){for(var n in r)for(o=0;o<i.length;o++)if(i[o].text==n){i[o].show=!0;break}}else for(var o=0;o<i.length;o++)i[o].show=!0;this._view.pageSize=20,this._view.sourceCollection=i,setTimeout(function(){e._view.pageSize=e._filter.maxValues,e._cmbFilter.text=e._filter.filterText||"",e._filterText=e._cmbFilter.text.toLowerCase()})},t.prototype.clearEditor=function(){this._cmbFilter.text="",this._filterText="",this._view.pageSize=0,this._view.refresh();for(var e=this._view.items,t=0;t<e.length;t++)e[t].show=!1;this._view.pageSize=this._filter.maxValues},t.prototype.updateFilter=function(){var e=null,t=this._view.items;if(this._filterText||this._cbSelectAll.indeterminate){e={};for(var i=0;i<t.length;i++){var r=t[i];r.show&&(e[r.text]=!0)}}this._filter.showValues=e,this._filter.filterText=""},t.prototype._filterTextChanged=function(){var e=this;this._toText&&clearTimeout(this._toText),this._toText=setTimeout(function(){var t=e._cmbFilter.text.toLowerCase(),i=t!=e._filterText;e._filterText=t,e._view.refresh(),i&&(e._cbSelectAll.checked=!0,e._cbSelectAllClicked())},300)},t.prototype._filterValues=function(e){return!this._filterText||!(!e||!e.text)&&e.text.toLowerCase().indexOf(this._filterText)>-1},t.prototype._cbSelectAllClicked=function(){for(var e=this._cbSelectAll.checked,t=this._view.items,i=this._divValues.scrollTop,r=0;r<t.length;r++)t[r].show=e;this._view.refresh(),this._divValues.scrollTop=i},t.prototype._updateSelectAllCheck=function(){for(var e=0,t=this._view.items,i=0;i<t.length;i++)t[i].show&&e++;0==e?(this._cbSelectAll.checked=!1,this._cbSelectAll.indeterminate=!1):e==t.length?(this._cbSelectAll.checked=!0,this._cbSelectAll.indeterminate=!1):this._cbSelectAll.indeterminate=!0},t.controlTemplate='<div><div wj-part="div-filter"></div><div class="wj-listbox-item"><label><input wj-part="cb-select-all" type="checkbox"> <span wj-part="sp-select-all"></span></label></div><div wj-part="div-values"></div></div>',t}(wjcCore.Control);exports.ValueFilterEditor=ValueFilterEditor;var ConditionFilter=function(){function e(e){this._c1=new FilterCondition(this),this._c2=new FilterCondition(this),this._and=!0,this._col=e,this._bnd=e.binding?new wjcCore.Binding(e.binding):null}return Object.defineProperty(e.prototype,"condition1",{get:function(){return this._c1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"condition2",{get:function(){return this._c2},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"and",{get:function(){return this._and},set:function(e){this._and=wjcCore.asBoolean(e),this._bnd=this._col&&this._col.binding?new wjcCore.Binding(this._col.binding):null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataMap",{get:function(){return this._map},set:function(e){this._map=wjcCore.asType(e,wjcGrid.DataMap,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"column",{get:function(){return this._col},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isActive",{get:function(){return this._c1.isActive||this._c2.isActive},enumerable:!0,configurable:!0}),e.prototype.apply=function(e){var t=this._col,i=this._c1,r=this._c2;if(!this._bnd||!this.isActive)return!0;e=this._bnd.getValue(e),t.dataMap?e=t.dataMap.getDisplayValue(e):wjcCore.isDate(e)?(wjcCore.isString(i.value)||wjcCore.isString(r.value))&&(e=wjcCore.Globalize.format(e,t.format)):wjcCore.isNumber(e)&&(e=wjcCore.Globalize.parseFloat(wjcCore.Globalize.format(e,t.format)));var n=i.apply(e),o=r.apply(e);return i.isActive&&r.isActive?this._and?n&&o:n||o:i.isActive?n:!r.isActive||o},e.prototype.clear=function(){this._c1.clear(),this._c2.clear(),this.and=!0},e.prototype.implementsInterface=function(e){return"IColumnFilter"==e},e}();exports.ConditionFilter=ConditionFilter;var ConditionFilterEditor=function(e){function t(t,i){var r=e.call(this,t)||this;r._filter=wjcCore.asType(i,ConditionFilter,!1);var n=r.getTemplate();r.applyTemplate("wj-control wj-conditionfilter-editor",n,{_divHdr:"div-hdr",_divCmb1:"div-cmb1",_divVal1:"div-val1",_btnAnd:"btn-and",_btnOr:"btn-or",_spAnd:"sp-and",_spOr:"sp-or",_divCmb2:"div-cmb2",_divVal2:"div-val2"});var o=wjcCore.culture.FlexGridFilter,l=o.ariaLabels;wjcCore.setAriaLabel(r._btnAnd,l.and),wjcCore.setAriaLabel(r._btnOr,l.or),wjcCore.setText(r._divHdr,o.header),wjcCore.setText(r._spAnd,o.and),wjcCore.setText(r._spOr,o.or),r._cmb1=r._createOperatorCombo(r._divCmb1,l.op1),r._cmb2=r._createOperatorCombo(r._divCmb2,l.op2),r._val1=r._createValueInput(r._divVal1,l.val1),r._val2=r._createValueInput(r._divVal2,l.val2);var a=r.hostElement;return r.addEventListener(a,"change",r._btnAndOrChanged.bind(r)),r.addEventListener(a,"keydown",r._keydown.bind(r)),r.updateEditor(),r}return __extends(t,e),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),t.prototype.updateEditor=function(){var e=this._filter.condition1,t=this._filter.condition2;this._cmb1.selectedValue=e.operator,this._cmb2.selectedValue=t.operator,this._val1 instanceof wjcInput.ComboBox?(this._val1.text=wjcCore.changeType(e.value,wjcCore.DataType.String,null),this._val2.text=wjcCore.changeType(t.value,wjcCore.DataType.String,null)):(this._val1.value=e.value,this._val2.value=t.value);var i=this._filter.and;this._checkRadio(this._btnAnd,i),this._checkRadio(this._btnOr,!i)},t.prototype.clearEditor=function(){this._cmb1.selectedValue=this._cmb2.selectedValue=null,this._val1.text=this._val2.text=null,this._checkRadio(this._btnAnd,!0),this._checkRadio(this._btnOr,!1)},t.prototype.updateFilter=function(){var e=this._filter.column,t=this._filter.condition1,i=this._filter.condition2;if(t.operator=this._cmb1.selectedValue,i.operator=this._cmb2.selectedValue,this._val1 instanceof wjcInput.ComboBox){var r=e.dataType==wjcCore.DataType.Date?wjcCore.DataType.String:e.dataType;t.value=wjcCore.changeType(this._val1.text,r,e.format),i.value=wjcCore.changeType(this._val2.text,r,e.format)}else t.value=this._val1.value,i.value=this._val2.value;this._filter.and=this._btnAnd.checked},t.prototype._createOperatorCombo=function(e,t){var i=this._filter.column,r=wjcCore.culture.FlexGridFilter,n=r.stringOperators,o=this._filter.dataMap||i.dataMap,l=wjcCore.DataType;i.dataType==l.Date&&this._hasDatePart(i.format)?n=r.dateOperators:i.dataType!=l.Number||o?i.dataType!=l.Boolean||o||(n=r.booleanOperators):n=r.numberOperators;var a=new wjcInput.ComboBox(e,{itemsSource:n,displayMemberPath:"name",selectedValuePath:"op"});return wjcCore.setAriaLabel(a.inputElement,t),a},t.prototype._createValueInput=function(e,t){var i=this._filter.column,r=this._filter.dataMap||i.dataMap,n=null,o=wjcCore.DataType;return i.dataType==o.Date&&this._hasDatePart(i.format)?(n=this._hasTimePart(i.format)?new wjcInput.InputDateTime(e):new wjcInput.InputDate(e)).format=i.format:i.dataType!=o.Number||r?(n=new wjcInput.ComboBox(e),r?(n.itemsSource=r.getDisplayValues(),n.isEditable=!0):i.dataType==o.Boolean&&(n.itemsSource=[!0,!1])):(n=new wjcInput.InputNumber(e)).format=i.format,n.isRequired=!1,wjcCore.setAriaLabel(n.inputElement,t),n},t.prototype._hasDatePart=function(e){return!e||(e=wjcCore.culture.Globalize.calendar.patterns[e]||e,/[yMd]+/.test(e))},t.prototype._hasTimePart=function(e){return!!e&&(e=wjcCore.culture.Globalize.calendar.patterns[e]||e,/[Hmst]+/.test(e))},t.prototype._btnAndOrChanged=function(e){var t=e.target==this._btnAnd,i=e.target==this._btnOr;(t||i)&&(this._checkRadio(this._btnAnd,t),this._checkRadio(this._btnOr,i))},t.prototype._checkRadio=function(e,t){e.checked=t,e.setAttribute("aria-checked",t.toString()),e.setAttribute("tabindex",t?"1":"-1")},t.prototype._keydown=function(e){var t=e.target==this._btnAnd,i=e.target==this._btnOr;if(t||i)switch(e.keyCode){case wjcCore.Key.Left:case wjcCore.Key.Right:case wjcCore.Key.Up:case wjcCore.Key.Down:var r=t?this._btnOr:this._btnAnd;r.click(),r.focus(),e.preventDefault()}},t.controlTemplate='<div><div wj-part="div-hdr"></div><div wj-part="div-cmb1"></div><br/><div wj-part="div-val1"></div><br/><div role="radiogroup" style="text-align:center"><label><input wj-part="btn-and" type="radio" role="radio"> <span wj-part="sp-and"></span> </label>&nbsp;&nbsp;&nbsp;<label><input wj-part="btn-or" type="radio" role="radio"> <span wj-part="sp-or"></span> </label></div><div wj-part="div-cmb2"></div><br/><div wj-part="div-val2"></div><br/></div>',t}(wjcCore.Control);exports.ConditionFilterEditor=ConditionFilterEditor;var FilterCondition=function(){function e(e){this._op=null,this._filter=e}return Object.defineProperty(e.prototype,"operator",{get:function(){return this._op},set:function(e){this._op=wjcCore.asEnum(e,Operator,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return this._val},set:function(e){if(this._val=e,this._strVal=wjcCore.isString(e)?e.toString().toLowerCase():null,this._mapVal=null,this._filter){var t=this._filter.dataMap||this._filter.column.dataMap;t&&(this._mapVal=t.getDisplayValue(e),wjcCore.isString(this._mapVal)&&(this._strVal=this._mapVal=this._mapVal.toLowerCase()))}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isActive",{get:function(){switch(this._op){case null:return!1;case Operator.EQ:case Operator.NE:return!0;default:return null!=this._val||null!=this._strVal}},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this.operator=null,this.value=null},e.prototype.apply=function(e){var t=this._mapVal||this._strVal||this._val;wjcCore.isString(e)&&(e=e.toLowerCase()),wjcCore.isString(t)&&null==e&&(e="");var i=Operator;switch(this._op){case null:return!0;case i.EQ:return null!=e&&null!=t?e.valueOf()==t.valueOf():e==t;case i.NE:return null!=e&&null!=t?e.valueOf()!=t.valueOf():e!=t;case i.GT:return e>t;case i.GE:return e>=t;case i.LT:return e<t;case i.LE:return e<=t;case i.BW:return!(null==this._strVal||!wjcCore.isString(e))&&0==e.indexOf(this._strVal);case i.EW:return!!(null!=this._strVal&&wjcCore.isString(e)&&e.length>=this._strVal.length)&&e.substr(e.length-this._strVal.length)==t;case i.CT:return!(null==this._strVal||!wjcCore.isString(e))&&e.indexOf(this._strVal)>-1;case i.NC:return!(null==this._strVal||!wjcCore.isString(e))&&e.indexOf(this._strVal)<0}throw"Unknown operator"},e}();exports.FilterCondition=FilterCondition;var Operator;!function(e){e[e.EQ=0]="EQ",e[e.NE=1]="NE",e[e.GT=2]="GT",e[e.GE=3]="GE",e[e.LT=4]="LT",e[e.LE=5]="LE",e[e.BW=6]="BW",e[e.EW=7]="EW",e[e.CT=8]="CT",e[e.NC=9]="NC"}(Operator=exports.Operator||(exports.Operator={}));var ColumnFilter=function(){function e(e,t){this._owner=e,this._col=t,this._valueFilter=new ValueFilter(t),this._conditionFilter=new ConditionFilter(t)}return Object.defineProperty(e.prototype,"filterType",{get:function(){return null!=this._filterType?this._filterType:this._owner.defaultFilterType},set:function(e){if((e=wjcCore.asEnum(e,FilterType,!0))!=this._filterType){var t=this.isActive;this.clear(),this._filterType=e,t?this._owner.apply():this._col.grid&&this._col.grid.invalidate()}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataMap",{get:function(){return this.conditionFilter.dataMap||this.valueFilter.dataMap},set:function(e){this.conditionFilter.dataMap=e,this.valueFilter.dataMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"valueFilter",{get:function(){return this._valueFilter},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"conditionFilter",{get:function(){return this._conditionFilter},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"column",{get:function(){return this._col},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isActive",{get:function(){return this._conditionFilter.isActive||this._valueFilter.isActive},enumerable:!0,configurable:!0}),e.prototype.apply=function(e){return this._conditionFilter.apply(e)&&this._valueFilter.apply(e)},e.prototype.clear=function(){this._valueFilter.clear(),this._conditionFilter.clear()},e.prototype.implementsInterface=function(e){return"IColumnFilter"==e},e}();exports.ColumnFilter=ColumnFilter,wjcCore._addCultureInfo("FlexGridFilter",{ariaLabels:{edit:"Edit Filter for Column",dialog:"Filter Editor for Column",asc:"Sort Column in Ascending Order",dsc:"Sort Column in Descending Order",search:"Search Item List",op1:"First Condition Operator",val1:"First Condition Value",and:"Require both Conditions",or:"Require either Condition",op2:"Second Condition Operator",val2:"Second Condition Value"},ascending:"↑ Ascending",descending:"↓ Descending",apply:"Apply",cancel:"Cancel",clear:"Clear",conditions:"Filter by Condition",values:"Filter by Value",search:"Search",selectAll:"Select All",null:"(nothing)",header:"Show items where the value",and:"And",or:"Or",stringOperators:[{name:"(not set)",op:null},{name:"Equals",op:Operator.EQ},{name:"Does not equal",op:Operator.NE},{name:"Begins with",op:Operator.BW},{name:"Ends with",op:Operator.EW},{name:"Contains",op:Operator.CT},{name:"Does not contain",op:Operator.NC}],numberOperators:[{name:"(not set)",op:null},{name:"Equals",op:Operator.EQ},{name:"Does not equal",op:Operator.NE},{name:"Is Greater than",op:Operator.GT},{name:"Is Greater than or equal to",op:Operator.GE},{name:"Is Less than",op:Operator.LT},{name:"Is Less than or equal to",op:Operator.LE}],dateOperators:[{name:"(not set)",op:null},{name:"Equals",op:Operator.EQ},{name:"Is Before",op:Operator.LT},{name:"Is After",op:Operator.GT}],booleanOperators:[{name:"(not set)",op:null},{name:"Equals",op:Operator.EQ},{name:"Does not equal",op:Operator.NE}]});var ColumnFilterEditor=function(e){function t(t,i,r){void 0===r&&(r=!0);var n=e.call(this,t,null,!0)||this;n.filterChanged=new wjcCore.Event,n.buttonClicked=new wjcCore.Event,n._filter=wjcCore.asType(i,ColumnFilter);var o=n.getTemplate();n.applyTemplate("wj-control wj-content wj-columnfiltereditor",o,{_divSort:"div-sort",_btnAsc:"btn-asc",_btnDsc:"btn-dsc",_divType:"div-type",_aVal:"a-val",_aCnd:"a-cnd",_divEdtVal:"div-edt-val",_divEdtCnd:"div-edt-cnd",_btnApply:"btn-apply",_btnCancel:"btn-cancel",_btnClear:"btn-clear"});var l=wjcCore.culture.FlexGridFilter,a=l.ariaLabels,s=n.hostElement,c=n.filter.column,u=c.grid.collectionView;wjcCore.setAttribute(s,"role","dialog"),wjcCore.setAriaLabel(s,a.dialog+" "+c.header),wjcCore.setAriaLabel(n._btnAsc,a.asc),wjcCore.setAriaLabel(n._btnDsc,a.dsc),wjcCore.setText(n._btnAsc,l.ascending),wjcCore.setText(n._btnDsc,l.descending),wjcCore.setText(n._aVal,l.values),wjcCore.setText(n._aCnd,l.conditions),wjcCore.setText(n._btnApply,l.apply),wjcCore.setText(n._btnCancel,l.cancel),wjcCore.setText(n._btnClear,l.clear);var d=n.filter.conditionFilter.isActive||0==(i.filterType&FilterType.Value)?FilterType.Condition:FilterType.Value;n._showFilter(d),r&&u&&u.canSort||(n._divSort.style.display="none");var p=n._btnClicked.bind(n);return n._btnApply.addEventListener("click",p),n._btnCancel.addEventListener("click",p),n._btnClear.addEventListener("click",p),n._btnAsc.addEventListener("click",p),n._btnDsc.addEventListener("click",p),n._aVal.addEventListener("click",p),n._aCnd.addEventListener("click",p),s.addEventListener("keydown",function(e){if(!e.defaultPrevented){var t=e.target.tagName.match(/^(a|button)$/i);switch(e.keyCode){case wjcCore.Key.Space:t&&(n._btnClicked(e),e.preventDefault());break;case wjcCore.Key.Enter:t?n._btnClicked(e):(n.updateFilter(),n.onFilterChanged(),n.onButtonClicked()),e.preventDefault();break;case wjcCore.Key.Escape:n.onButtonClicked(),e.preventDefault();break;case wjcCore.Key.Tab:wjcCore.moveFocus(n.hostElement,e.shiftKey?-1:1),e.preventDefault()}}}),n}return __extends(t,e),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),t.prototype.updateEditor=function(){this._edtVal&&this._edtVal.updateEditor(),this._edtCnd&&this._edtCnd.updateEditor()},t.prototype.updateFilter=function(){switch(this._getFilterType()){case FilterType.Value:this._edtVal.updateFilter(),this.filter.conditionFilter.clear();break;case FilterType.Condition:this._edtCnd.updateFilter(),this.filter.valueFilter.clear()}},t.prototype.onFilterChanged=function(e){this.filterChanged.raise(this,e)},t.prototype.onButtonClicked=function(e){this.buttonClicked.raise(this,e)},t.prototype._handleResize=function(){this.isTouching||this._wasTouching||this.onButtonClicked()},t.prototype._showFilter=function(e){this._wasTouching=this.isTouching,e==FilterType.Value&&null==this._edtVal&&(this._edtVal=new ValueFilterEditor(this._divEdtVal,this.filter.valueFilter)),e==FilterType.Condition&&null==this._edtCnd&&(this._edtCnd=new ConditionFilterEditor(this._divEdtCnd,this.filter.conditionFilter)),0!=(e&this.filter.filterType)&&(e==FilterType.Value?(this._divEdtVal.style.display="",this._divEdtCnd.style.display="none",this._enableLink(this._aVal,!1),this._enableLink(this._aCnd,!0),this._edtVal.focus()):(this._divEdtVal.style.display="none",this._divEdtCnd.style.display="",this._enableLink(this._aVal,!0),this._enableLink(this._aCnd,!1),this._edtCnd.focus()));var t=this._divType.style;switch(this.filter.filterType){case FilterType.None:case FilterType.Condition:case FilterType.Value:t.display="none";break;default:t.display=""}},t.prototype._enableLink=function(e,t){wjcCore.toggleClass(e,"wj-state-disabled",!t),wjcCore.setAttribute(e,"href",t?"":null),wjcCore.setAttribute(e,"disabled",t?null:"disabled")},t.prototype._getFilterType=function(){var e=FilterType;return"none"!=this._divEdtVal.style.display?e.Value:e.Condition},t.prototype._btnClicked=function(e){var t=e.target;if(e.preventDefault(),e.stopPropagation(),!wjcCore.hasClass(t,"wj-state-disabled")){if(t==this._aVal)return this._showFilter(FilterType.Value),void wjcCore.moveFocus(this._edtVal.hostElement,0);if(t==this._aCnd)return this._showFilter(FilterType.Condition),void wjcCore.moveFocus(this._edtCnd.hostElement,0);if(t==this._btnAsc||t==this._btnDsc){var i=this.filter.column,r=i.sortMemberPath?i.sortMemberPath:i.binding,n=i.grid.collectionView,o=new wjcCore.SortDescription(r,e.target==this._btnAsc);n.sortDescriptions.deferUpdate(function(){n.sortDescriptions.clear(),n.sortDescriptions.push(o)})}t==this._btnApply?(this.updateFilter(),this.onFilterChanged()):t==this._btnClear?this.filter.isActive&&(this.filter.clear(),this.onFilterChanged()):this.updateEditor(),this.onButtonClicked()}},t.controlTemplate='<div><div wj-part="div-sort"><button wj-part="btn-asc" class="wj-btn" style="min-width:95px"></button>&nbsp;&nbsp;&nbsp;<button wj-part="btn-dsc" class="wj-btn" style="min-width:95px"></button></div><div wj-part="div-type" class="wj-filtertype"><a wj-part="a-cnd" href="" draggable="false"></a>&nbsp;|&nbsp;<a wj-part="a-val" href="" draggable="false"></a></div><div wj-part="div-edt-val" tabindex="-1"></div><div wj-part="div-edt-cnd" tabindex="-1"></div><div style="text-align:right;margin-top:10px"><button wj-part="btn-apply" class="wj-btn"></button>&nbsp;&nbsp;<button wj-part="btn-cancel" class="wj-btn"></button>&nbsp;&nbsp;<button wj-part="btn-clear" class="wj-btn"></button></div>',t}(wjcCore.Control);exports.ColumnFilterEditor=ColumnFilterEditor;var FilterType;!function(e){e[e.None=0]="None",e[e.Condition=1]="Condition",e[e.Value=2]="Value",e[e.Both=3]="Both"}(FilterType=exports.FilterType||(exports.FilterType={}));var FlexGridFilter=function(){function e(e,t){this._showIcons=!0,this._showSort=!0,this._defFilterType=FilterType.Both,this.filterApplied=new wjcCore.Event,this.filterChanging=new wjcCore.Event,this.filterChanged=new wjcCore.Event;var i="Missing dependency: FlexGridFilter requires ";wjcCore.assert(null!=wjcGrid,i+"wijmo.grid."),wjcCore.assert(null!=wjcInput,i+"wijmo.input."),this._filters=[],this._g=wjcCore.asType(e,wjcGrid.FlexGrid,!1),this._g.formatItem.addHandler(this._formatItem.bind(this)),this._g.itemsSourceChanged.addHandler(this.clear.bind(this));var r=this._g.hostElement;e.addEventListener(r,"mousedown",this._mousedown.bind(this),!0),e.addEventListener(r,"click",this._click.bind(this),!0),e.addEventListener(r,"keydown",this._keydown.bind(this),!0),this._g.invalidate(),t&&wjcCore.copy(this,t)}return Object.defineProperty(e.prototype,"grid",{get:function(){return this._g},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterColumns",{get:function(){return this._filterColumns},set:function(e){this._filterColumns=wjcCore.asArray(e),this.clear()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"showFilterIcons",{get:function(){return this._showIcons},set:function(e){e!=this.showFilterIcons&&(this._showIcons=wjcCore.asBoolean(e),this._g&&this._g.invalidate())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"showSortButtons",{get:function(){return this._showSort},set:function(e){this._showSort=wjcCore.asBoolean(e)},enumerable:!0,configurable:!0}),e.prototype.getColumnFilter=function(e,t){void 0===t&&(t=!0),e=this._asColumn(e);for(var i=0;i<this._filters.length;i++)if(this._filters[i].column==e)return this._filters[i];if(t&&e.binding){var r=new ColumnFilter(this,e);return this._filters.push(r),r}return null},Object.defineProperty(e.prototype,"defaultFilterType",{get:function(){return this._defFilterType},set:function(e){(e=wjcCore.asEnum(e,FilterType,!1))!=this.defaultFilterType&&(this._defFilterType=e,this._g.invalidate(),this.clear())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterDefinition",{get:function(){for(var e={defaultFilterType:this.defaultFilterType,filters:[]},t=0;t<this._filters.length;t++){var i=this._filters[t];if(i&&i.column&&i.column.binding&&(i.isActive||i.filterType!=this.defaultFilterType)){var r={binding:i.column.binding};if(i.conditionFilter.isActive){var n=i.conditionFilter;r={binding:i.column.binding,type:"condition",condition1:{operator:n.condition1.operator,value:n.condition1.value},and:n.and,condition2:{operator:n.condition2.operator,value:n.condition2.value}}}else if(i.valueFilter.isActive){var o=i.valueFilter;r={binding:i.column.binding,type:"value",filterText:o.filterText,showValues:o.showValues}}i.filterType!=this.defaultFilterType&&(r.filterType=i.filterType),e.filters.push(r)}}return JSON.stringify(e)},set:function(e){if(e=wjcCore.asString(e),this.clear(),e){var t=JSON.parse(e);this.defaultFilterType=t.defaultFilterType;for(var i=0;i<t.filters.length;i++){var r=t.filters[i],n=this._g.getColumn(r.binding),o=this.getColumnFilter(n,!0);if(o)switch(null!=r.filterType&&(o.filterType=wjcCore.asEnum(r.filterType,FilterType)),r.type){case"condition":var l=o.conditionFilter;l.condition1.value=n.dataType==wjcCore.DataType.Date?wjcCore.changeType(r.condition1.value,n.dataType,null):r.condition1.value,l.condition1.operator=r.condition1.operator,l.and=r.and,l.condition2.value=n.dataType==wjcCore.DataType.Date?wjcCore.changeType(r.condition2.value,n.dataType,null):r.condition2.value,l.condition2.operator=r.condition2.operator;break;case"value":var a=o.valueFilter;a.filterText=r.filterText,a.showValues=r.showValues}}}this.apply()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activeEditor",{get:function(){return wjcCore.Control.getControl(this._divEdt)},enumerable:!0,configurable:!0}),e.prototype.editColumnFilter=function(e,t,i){var r=this;this.closeEditor(),e=this._asColumn(e);var n=this._g,o=new wjcGrid.CellRangeEventArgs(n.cells,new wjcGrid.CellRange(-1,e.index));if(this.onFilterChanging(o)){o.cancel=!0;var l=wjcCore.createElement('<div class="wj-dropdown-panel"></div>'),a=this.getColumnFilter(e),s=new ColumnFilterEditor(l,a,this.showSortButtons);this._divEdt=l,this._edtCol=e,n.rightToLeft&&(l.dir="rtl"),s.filterChanged.addHandler(function(){o.cancel=!1,setTimeout(function(){o.cancel||r.apply()})}),s.buttonClicked.addHandler(function(){r.closeEditor(),n.focus(),r.onFilterChanged(o)}),s.lostFocus.addHandler(function(){setTimeout(function(){var e=wjcCore.Control.getControl(r._divEdt);e&&!e.containsFocus()&&r.closeEditor()},10)});var c=t?t.col:e.index;t||n.columns[c].binding==e.binding||(c=n.selection.leftCol),n._edtHdl._commitRowEdits(),n.scrollIntoView(-1,c,!0);var u=n.columnHeaders,d=t&&t.panel==u?t.row:u.rows.length-1,p=c,h=u.getCellBoundingRect(d,p),f=i||u.getCellElement(d,p);f?wjcCore.showPopup(l,f,!1,!1,!1):wjcCore.showPopup(l,h),this._setAriaExpanded(f,!0),this._setAriaExpanded(n.cells.getCellElement(-1,p),!0);for(var _=s.hostElement.querySelectorAll("input"),b=0;b<_.length;b++){var v=_[b];if(v.offsetHeight>0&&v.tabIndex>-1&&!v.disabled){v.focus();break}}s.containsFocus()||s.focus()}else this._divEdt=this._edtCol=null},e.prototype._setAriaExpanded=function(t,i){if(t){var r=t.querySelector("."+e._WJC_FILTER);wjcCore.setAttribute(r,"aria-expanded",i)}},e.prototype.closeEditor=function(){var e=this._g,t=wjcCore.Control.getControl(this._divEdt),i=this._edtCol;if(t&&wjcCore.hidePopup(t.hostElement,function(){t.dispose()}),i){var r=e.columnHeaders,n=r.rows.length?r.getCellElement(r.rows.length-1,i.index):null;this._setAriaExpanded(n,!1),n=e.cells.getCellElement(-1,i.index),this._setAriaExpanded(n,!1)}this._divEdt=null,this._edtCol=null},e.prototype.apply=function(){var e=this._g.collectionView;if(e){var t=this._g.editableCollectionView;t&&(t.commitEdit(),t.commitNew()),e.filter=this._filter.bind(this)}var i=e?e.updateFilterDefinition:null;wjcCore.isFunction(i)&&i.call(e,this),this.onFilterApplied()},e.prototype.clear=function(){this._filters.length&&(this._filters=[],this.apply())},e.prototype.onFilterApplied=function(e){this.filterApplied.raise(this,e)},e.prototype.onFilterChanging=function(e){return this.filterChanging.raise(this,e),!e.cancel},e.prototype.onFilterChanged=function(e){this.filterChanged.raise(this,e)},e.prototype._asColumn=function(e){return wjcCore.isString(e)?this._g.getColumn(e):wjcCore.isNumber(e)?this._g.columns[e]:wjcCore.asType(e,wjcGrid.Column,!1)},e.prototype._filter=function(e){for(var t=0;t<this._filters.length;t++)if(!this._filters[t].apply(e))return!1;return!0},e.prototype._formatItem=function(e,t){if(t.panel==e.columnHeaders){var i=this._g,r=i.getMergedRange(t.panel,t.row,t.col)||new wjcGrid.CellRange(t.row,t.col),n=i.columns[r.col],o=i._getBindingColumn(t.panel,t.row,n),l=t.cell;if(r.row2==t.panel.rows.length-1||n!=o){var a=this.getColumnFilter(o,this.defaultFilterType!=FilterType.None);this._filterColumns&&this._filterColumns.indexOf(o.binding)<0&&(a=null),a?(wjcCore.toggleClass(l,"wj-filter-on",a.isActive),wjcCore.toggleClass(l,"wj-filter-off",!a.isActive)):(wjcCore.removeClass(l,"wj-filter-on"),wjcCore.removeClass(l,"wj-filter-off")),a&&a.filterType!=FilterType.None&&(this._showIcons&&this._addFilterButton(o,a,l),0==t.row&&(l=i.cells.getCellElement(-1,t.col))&&this._addFilterButton(n,a,l))}}},e.prototype._addFilterButton=function(t,i,r){var n=e._WJC_FILTER,o=wjcCore.createElement('<button class="wj-btn wj-btn-glyph wj-right '+n+'" type="button" tabindex="-1"><span class="wj-glyph-filter"></span></button>');wjcCore.setAriaLabel(o,wjcCore.culture.FlexGridFilter.ariaLabels.edit+" "+t.header),wjcCore.setAttribute(o,"aria-haspopup","dialog"),wjcCore.setAttribute(o,"aria-expanded",!1),wjcCore.setAttribute(o,"aria-describedby",t.describedById),wjcCore.setAttribute(o,"aria-pressed",i.isActive),r.querySelector("."+n)||(1==r.children.length&&(r=r.querySelector("div")||r),r.appendChild(o))},e.prototype._mousedown=function(e){this._toggleEditor(e)&&(this._tmd=!0,e.stopPropagation(),e.preventDefault())},e.prototype._click=function(e){(this._tmd||this._toggleEditor(e))&&(e.stopPropagation(),e.preventDefault()),this._tmd=!1},e.prototype._toggleEditor=function(t){var i=this;if(this._tmd=!1,!t.defaultPrevented&&0==t.button)if(wjcCore.closestClass(t.target,e._WJC_FILTER)){var r=this._g,n=r.hitTest(t.target);if(n.panel||(n=r.hitTest(t)),n.panel==r.columnHeaders||n.panel==r.cells&&-1==n.row){var o=r.columns[n.col],l=r._getBindingColumn(n.panel,n.row,o);return this._divEdt&&this._edtCol==l?(this.closeEditor(),r.focus()):setTimeout(function(){i.editColumnFilter(l,n)},this._divEdt?100:0),!0}}else this.closeEditor();return!1},e.prototype._keydown=function(e){if(!e.defaultPrevented&&!e.ctrlKey&&e.altKey&&(e.keyCode==wjcCore.Key.Down||e.keyCode==wjcCore.Key.Up)){var t=this.grid,i=t.selection,r=i.col>-1?t.columns[i.col]:null,n=r?t._getBindingColumn(t.cells,i.row,r):null;n&&!n.dataMap&&this.getColumnFilter(n,!0)&&(this.editColumnFilter(n),e.preventDefault(),e.stopPropagation())}},e._WJC_FILTER="wj-elem-filter",e}();exports.FlexGridFilter=FlexGridFilter;